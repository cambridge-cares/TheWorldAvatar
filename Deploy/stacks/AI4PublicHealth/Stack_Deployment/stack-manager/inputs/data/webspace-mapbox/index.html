<html>
    <head>
        <!-- ===== CUSTOMISABLE ===== -->
        <title>Digital Twin Cities powered by TWA</title>
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- JS -->
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <script src="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.js"></script>
        <script src="https://kg.cmclinnovations.com/cdn/dtvf/3.4.0/dtvf.min.js"></script>

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- JavaScript files to provide functionality specifically for this visualisation instance can go here. -->
        <!-- <script src="./local.js"></script> -->
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- CSS -->
        <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.min.css" rel="stylesheet">
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet">
        <link href="https://kg.cmclinnovations.com/cdn/dtvf/3.4.0/dtvf.min.css" rel="stylesheet" />

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- CSS files to provide styling specifically for this visualisation instance can go here. -->
        <!-- <link href="./local.css" rel="stylesheet" /> -->
        <!-- ===== CUSTOMISABLE ===== -->
        <style>
            /* Assuming the black frame is a border or box-shadow */
            #sidePanelLegend, #sidePanelLegend #legendContainer {
                border: none; /* Remove border */
                box-shadow: none; /* Remove box-shadow */
                padding: 0; /* Adjust padding if needed */
            }
    
            /* Adjust other properties as necessary to fine-tune the appearance */
            /* Styling for the Attributions button and panel */
            #attributionButtonContainer {
                position: absolute;
                bottom: 10px;
                left: 10px;
                z-index: 1000; /* Ensure it appears above other elements */
            }

            #attributionToggle {
                background-color: #ffffff;
                border: 1px solid #cccccc;
                padding: 5px 10px;
                font-size: 12px;
                cursor: pointer;
            }

            #attributionPanel {
                position: absolute;
                bottom: 50px;  /* Position remains the same */
                left: 10px;
                background-color: rgba(255, 255, 255, 0.9);
                padding: 10px;
                border: 1px solid #cccccc;
                font-size: 12px;
                z-index: 1000; /* Ensure it appears above other elements */
                max-width: 300px;
                line-height: 1.5;  /* Improve readability */
                display: none; /* Initially hidden */
                white-space: normal;  /* Ensures text wraps properly */
            }

            #attributionPanel h3 {
                margin-top: 0;
                margin-bottom: 10px;
                text-align: left; /* Align title to the left */
            }

            #attributionPanel p {
                margin: 0 0 10px 0;  /* Add spacing between paragraphs */
                text-align: left; /* Align text to the left */
                width: 100%;  /* Ensure the text takes up the full width */
                display: block;
            }

        </style> 
    </head>
    <body>
        <!-- Container the map will be added to -->
        <div id="map"></div>

        <!-- Element for depth of field overlay -->
        <div id="tiltShift"></div>

        <!-- Element the map controls will be added to (normally on the left) -->
        <div id="controlsContainer">
            <div id="controlContainer">

                <!-- Camera controls -->
                <div id="cameraContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Camera</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapboxUtils.setTiltshift(this.checked)"><span class="slider round"><p>DoF</p></label>
                            <span class="tooltiptext">Toggle depth of field effect</span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <a href="#" onclick="MapboxUtils.resetCamera()">Reset to default</a><br/>
                    </div>
                </div>

                <!-- Terrain controls -->
                <div id="terrainContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Imagery</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapboxUtils.set3DTerrain(this.checked)"><span class="slider round"><p>3D</p></label>
                            <span class="tooltiptext">Toggle 3D terrain</span>
                        </div>
                    </div>
                    <div id="imageryContainer" class="controlContents">
                    </div>
                </div>

                <!-- Layer controls -->
                <div id="layerContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Layers</p>
                        <div class="tooltip" id="placenameContainer">
                            <label class="switch"><input type="checkbox" onclick="MapboxUtils.setPlacenames(this.checked)" checked><span class="slider round"><p>PNs</p></label>
                            <span class="tooltiptext">Toggle place names, labels, and roads </span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <div id="layerTreeContainer">
                            <div class="hummingbird-treeview-converter"></div>
                        </div>
                    </div>
                </div>

                <!-- Help icon -->
                <div id="helpContainer" class="controlBlock expanded" onclick="openHelpURL()">
                    <div class="tooltip" id="coordEditor">
                        <i class="fas fa-question fa-lg"></i>
                        <span class="tooltiptext right">Help</span>
                    </div>
                </div>

                <!-- Container for developer info -->
                <div id="developerContainer" class="controlBlock" style="display: none;">
                    <div class="tooltip" id="coordEditor" style="float: right;">
                        <i class="fas fa-pencil-alt" onclick="event.stopPropagation(); manager.getControlHandler().editInfoPanel()"></i>
                        <span class="tooltiptext">Change map position</span>
                    </div>
                    <div id="coordsContainer" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Side panel for content and metdata -->
        <div id="sidePanel" class="large expanded">
            <div class="tooltip" id="slideButtonContainer">
                <i class="fas fa-chevron-right" id="slideButton" width="16px" class="leftButton" height="16px" onclick="manager.getPanelHandler().toggleExpansion()"></i>
                <span class="tooltiptext">Show/Hide</span>
            </div>
            <div class="tooltip" id="expandButtonContainer">
                <i class="fas fa-compress-alt" id="expandButton" width="16px" class="rightButton" height="16px" onclick="manager.getPanelHandler().toggleMode()"></i>
                <span class="tooltiptext">Expand/Collapse</span>
            </div>
            <div id="sidePanelInner">
                <ul>
                    <li><a href="#sidePanelGeneral">General</a></li>
                    <li><a href="#sidePanelLegend">Legend</a></li>
                </ul>
                <div id="sidePanelGeneral">
                    <div id="titleContainer" onclick="manager.moveMapToFeature()"></div>
                    <div id="contentContainer"></div>
                    <div id="legendContainer"></div>
                    <div id="footerContainer">
                        <div id="footerContent"></div>
                    </div>
                </div>
                <div id="sidePanelLegend"> <!-- Add this block for legend content -->
                    <div id="legendContainer">
                        <!-- Environmental Sensors -->
                        <h3>Environmental Sensors</h3>
                        <ul>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/air_airquality.png" alt="Air Quality" style="width: 24px; height: 24px; vertical-align: middle;"> Air Quality
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/met_weather-obs.png" alt="Weather Observation" style="width: 24px; height: 24px; vertical-align: middle;"> Weather Observation
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/met_weather-for.png" alt="Weather Forecast" style="width: 24px; height: 24px; vertical-align: middle;"> Weather Forecast
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/ea_flow.png" alt="Flood Monitoring (Flow)" style="width: 24px; height: 24px; vertical-align: middle;"> Flood Monitoring (Flow)
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/ea_water-level.png" alt="Flood Monitoring (Water Level)" style="width: 24px; height: 24px; vertical-align: middle;"> Flood Monitoring (Water Level)
                            </li>
                        </ul>

                        <!-- Food Retail -->
                        <h3>Food Retail</h3>
                        <ul>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/supermarket.png" alt="Supermarket" style="width: 24px; height: 24px; vertical-align: middle;"> Supermarket
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/takeaway.png" alt="Takeaway" style="width: 24px; height: 24px; vertical-align: middle;"> Takeaway
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/FoodHygieneRating.png" alt="Food Hygiene Rating" style="width: 24px; height: 24px; vertical-align: middle;"> Food Hygiene Rating
                            </li>
                        </ul>

                        <!-- Public Services -->
                        <h3>Public Services</h3>
                        <ul>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/edu_and_health.png" alt="Education and Health" style="width: 24px; height: 24px; vertical-align: middle;"> Education and Health
                            </li>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/public_infras.png" alt="Public Infrastructure" style="width: 24px; height: 24px; vertical-align: middle;"> Public Infrastructure
                            </li>
                        </ul>

                        <!-- Entertainment and Recreation -->
                        <h3>Recreation</h3>
                        <ul>
                            <li style="line-height: 30px; font-size: 18px;">
                                <img src="data/icons/sports.png" alt="Sport and Entertainment" style="width: 24px; height: 24px; vertical-align: middle;"> Sport and Entertainment
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="returnContainer" style="display: none;">
                <div id="innerReturnContainer">
                    <a href="#" onclick="manager.getPanelHandler().returnToDefault()"><i class="fas fa-arrow-left" width="16px" height="16px"></i> Return</a>
                </div>
            </div>
        </div>

        <!-- Attributions button and panel -->
        <div id="attributionButtonContainer">
            <button id="attributionToggle" onclick="toggleAttribution()">Attributions</button>
        </div>
        <div id="attributionPanel" style="display: none;">
            <h3>Attributions</h3>
            <p>Contains OS data copyright and database rights 2022 (100025252)</p>
            <p>Contains public sector information licensed under the Open Government Licence v3.0.</p>
            <p>This showcase uses Environment Agency flood and river level data from the real-time data API (Beta).</p>
        </div>

        <!-- Code entry point -->
        <script>
            $("#sidePanelInner").tabs();

            // ===== CUSTOMISABLE =====
            // Enter Mapbox account name and API key here!
            MapHandler.MAP_USER = "jc2341";
            MapHandler.MAP_API = "pk.eyJ1IjoiamMyMzQxIiwiYSI6ImNsZzViaGo4cjAxdmMzbnFua3czMmM3OXoifQ.mITpZgODb8LGw00pFksvoA";
            // ===== CUSTOMISABLE =====

            // Create a new manager instance
            var manager = new Manager(MapProvider.MAPBOX);
            window.manager = manager;

            // Only start the map after data definitions have been read.
            var dataPromise = manager.loadDefinitions();
            dataPromise.then(() => start());

            /**
             * Starts the visualisation setup process.
             */
            function start() {
                // Initialise the map object
                manager.initialiseMap();
               
                // ===== CUSTOMISABLE =====
                // Set the default content in the "General" tab of the side panel
                manager.getPanelHandler().setTitle("<h1>AI for public health</h1>");
                manager.getPanelHandler().setContent(`
                <p>The health benefits of diet and physical activity are well established. However, the environment influences these behaviours and hence health risk. Previous research has examined the role of the environment using addresses but this misses where people go, when they go, and what they do. This means that the interplay between environmental exposures and personal behaviours is missed.</p>
                <p>We address this gap using existing timestamped measures of physical activity, location and diet from a large population-based cohort of over 10,000 adults in England. Using AI methods including autonomous agents acting on a knowledge graph, we will combine location and geospatial data to quantify personal dynamic environmental exposures to support epidemiological analysis of the cohort.</p>
                <p>Results will be relevant to local authorities, including more detailed understanding of how people use space and the duration and timing of health-related exposures. Long term, this research could facilitate real-time nudges of health behaviours using smartphones.</p>
                <p>This visualisation shows an example of our work in progress.</p>
                `);

                manager.getPanelHandler().setFooter("The World Avatar, " + new Date().getFullYear());
                // ===== CUSTOMISABLE =====

                // Save general tab state as default
                manager.getPanelHandler().storeDefault();

                // Once the underlying style has loaded...
                MapHandler.MAP.on("style.load", function() {
                    // Load registered images and linked files
                    manager.loadImagesAndLinks().then(() => {

                        // TODO: This SHOULD only kick in after all images have bee loaded and added to the map,
                        // but I cannot get the nest Promises to wait for each other properly. As it doesn't
                        // seem to be causing any issues, I'm leaving it as is for the time being. - Michael

                        // Plot the default visible data
                        manager.plotData();
                    });
                });
            }

            function toggleAttribution() {
                var attributionContent = document.getElementById('attributionPanel');
                if (attributionContent.style.display === 'none') {
                    attributionContent.style.display = 'block';
                } else {
                    attributionContent.style.display = 'none';
                }
            }

          
        </script>
    </body>
</html>
