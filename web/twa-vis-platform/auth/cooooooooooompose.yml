services:
  keycloak:
    container_name: "bnl-keycloak-server"
    image: keycloak/keycloak:latest
    ports:
      - "8081:8080"
    environment:  
      KC_FEATURES: "hostname:v2"
      KC_LOG_LEVEL: debug
      KC_HOSTNAME: "https://theworldavatar.io/bnl/authorisation/"
      # KC_HTTP_RELATIVE_PATH : "/bnl/authorisation/"
      KC_HOSTNAME_DEBUG: true
      # KC_HOSTNAME_ADMIN: https://theworldavatar.io/bnl/admin/
      KC_HOSTNAME_BACKCHANNEL_DYNAMIC: true # needed to allow other containers to commumicate with keycloak server-side
      KC_HTTP_ENABLED: true ## this replaces the proxy mode (whether to forward in SSL or not), works if we assume this is edge server
      KC_PROXY_HEADERS: xforwarded ## this replaces the proxy mode (whether to forward in SSL or not)
      KC_TLS_HOSTNAME_VERIFIER: ANY
    command: start --optimized --import-realm
    volumes:
      - ./realm:/opt/keycloak/data/import:ro # the realm to import
    networks:
      - app-network

  keycloak-dev:
    container_name: "bnl-keycloak-server"
    image: keycloak/keycloak:latest
    ports:
      - "8081:8080"
    environment:
      KEYCLOAK_ADMIN: oisin
      KEYCLOAK_ADMIN_PASSWORD: liffey-swim
      KC_LOG_LEVEL: info
      KC_HOSTNAME_PORT: 
    command: start-dev
    profiles:
      - dev

  redis:
    container_name: "bnl-redis"
    image: redis:latest
    ports:
      - "6379:6379"
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf

  # nginx-proxy-manager:
  #   container_name: "nginx-proxy-manager"
  #   image: jc21/nginx-proxy-manager:latest
  #   ports:
  #     - "80:80"
  #     - "81:81"
  #     - "443:443"
  #   environment:
  #     DB_SQLITE_FILE: "/data/database.sqlite"
  #   volumes:
  #     - ./data:/data
  #     - ./letsencrypt:/etc/letsencrypt
  #   networks:
  #     - app-network

networks:
  app-network:
    driver: bridge