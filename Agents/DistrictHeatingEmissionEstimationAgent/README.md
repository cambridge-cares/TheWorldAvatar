# District Heating Emission Estimation Agent

This `Emission Agent` converts `ConsumedGasAmount`s and `ProvidedHeatAmount`s (as instantiated by the District Heating Optimisation Agent according to [OntoHeatNetwork]) into associated `Emission` instances according to [OntoDispersion]. The estimation and instantiation of associated emissions is required to simulate emission dispersion using `Aermod Agent`; however, the assessment of emissions is 1) currently limited to NO<sub>2</sub>, PM<sub>10</sub> , and PM<sub>2.5</sub> and 2) solely based on emission factors found in the literature instead of a detailed combustion model.

The agent is implemented using the [Derived Information Framework] to ensure proper data provenance. The required input instances to derive emissions are described in the [required derivation markup](#13-required-derivation-markup) section below. The agent is designed to be deployed as a Docker container and can be deployed either as standalone version or as part of a larger Docker stack.


&nbsp;
# 1. Setup

This section specifies the minimum requirements to build and deploy the Docker image. 

## 1.1 Agent Settings

The dockerised agent can be deployed as "standalone" version (i.e., outside a larger Docker stack) or deployed to an (existing) stack. Several key environment variables need to be set in the
- [docker compose file] for "standalone" deployment
- [stack manager input config file] for deployment using the [Stack manager]

```bash
#--- Deployment specific parameters ---#
# Required for Stack deployment (can be left blank for "standalone" deployment)
STACK_NAME                    # Will be set automatically when deployed via stack-manager
NAMESPACE                     # Blazegraph namespace (within Stack) to monitor
DATABASE                      # PostGIS/PostgreSQL database name (default: `postgres`)
# Required for "standalone" deployment (can be left blank for Stack deployment)
STACK_NAME                    # to be left blank for "standalone" deployment
DB_URL                        # PostGIS/PostgreSQL URL
DB_USER                       # PostGIS/PostgreSQL username
DB_PASSWORD                   # PostGIS/PostgreSQL password

#--- Derivation Agent parameters ---#
SPARQL_QUERY_ENDPOINT         # SPARQL endpoint to monitor/update
SPARQL_UPDATE_ENDPOINT        # SPARQL endpoint to monitor/update
ONTOAGENT_SERVICE_IRI         # IRI of OntoAgent service
ONTOAGENT_OPERATION_HTTP_URL  # Port needs to match port specified in `docker-compose.yml`
DERIVATION_INSTANCE_BASE_URL  # Base IRI of all instanced generated by agent
DERIVATION_PERIODIC_TIMESCALE # Interval in which to check for updated KG information (in s)
                              # (irrelevant as Forecasting Agent uses synchronous derivations only)
REGISTER_AGENT                # Boolean flag whether to register agent in KG (`true` required to detect derivations)
# Required inputs for DerivationAgent to start, although not relevant for ForecastingAgent (i.e., shall be left blank)
KG_USERNAME
KG_PASSWORD
FILE_SERVER_ENDPOINT
FILE_SERVER_USERNAME
FILE_SERVER_PASSWORD
```

## 1.2 Miscellaneous

**Only relevant** if you intend to build (and publish) the Docker image:

- Ensure access to CMCL Docker registry: 
    The required `stack-clients-*.jar` resource to be added to [py4jps] during building the Docker image is retrieved from the Stack-Clients docker image published on `docker.cmclinnovations.com`. Hence, access to the CMCL Docker registry is required from the machine building the agent image. For more information regarding the registry, see the [CMCL Docker registry wiki page].

- Ensure access to Github container registry:
    A `publish_docker_image.sh` convenience script is provided to build and publish the agent image to the [Github container registry]. To publish a new image, your github user name and [personal access token] (which must have a `scope` that [allows you to publish and install packages]) needs to be provided. 


## 1.3 Required Derivation Markup

Before any emissions can be estimated (and instantiated), all required inputs need to be properly instantiated. This includes:
- 1 `dh:ProvidedHeatAmount` or 1 or more `dh:ConsumedGasAmount`s: instances associated with (optimised) time series for consumed gas and externally sourced heat amounts; either exactly one `dh:ProvidedHeatAmount` or at least one `dh:ConsumedGasAmount` instance is required to evaluate emissions
- 1 `disp:SimulationTime`: the time stamp for which to estimate the emissions, i.e., for which later also to simulate the emission dispersion; please note that this time stamp needs to be within the time series of the `dh:ProvidedHeatAmount` or `dh:ConsumedGasAmount`
- 1 `disp:StaticPointSource`: the instance describing the location which `disp:emits` the estimated emissions; please note that this instance needs to have a `disp:hasOntoCityGMLCityObject` relationship attached for the `Aermod Agent` to work later

The [example triples] used for the integration tests provide an example of the expected instantiation structure, and also reference the used namespace prefixes.


&nbsp;
# 2. Agent Logic

The estimation logic is rather rudimentary, but sufficient to demonstrate the overall approach to link the district heating optimisation with dispersion modelling:

1) Extract time series for marked up `dh:ProvidedHeatAmount` or `dh:ConsumedGasAmount`(s) from KG
2) Summarise `dh:ConsumedGasAmount`(s) values per time step (to account for multiple boilers and GT emitting emissions through same chimney)
3) Extract values for target time step
4) Estimate emissions using emission factors from literature
    - Current focus on NO<sub>2</sub>, PM<sub>10</sub> , and PM<sub>2.5</sub> only
    - Treat flue gas stream as hot air (using flue gas temperatures from literature)


&nbsp;
# 3. Using the Agent

## 3.1 Building the Agent

To build and publish the agent Docker image, please use the following commands. Please note that both commands are bundled in the  `publish_docker_image.sh` convenience script.

```bash
# Building the (production) image
docker compose -f docker-compose.yml build
# Publish the Docker image to the Github container registry
docker image push ghcr.io/cambridge-cares/<image tag>:<version>
```

Time out issues have been observed when building the image. If this happens, please try pulling the required stack-clients image first by `docker pull docker.cmclinnovations.com/stack-client:1.6.2`.

## 3.2 Deploying the Agent

It is recommended to pull the published Docker image from [Github container registry] for sole deployment (i.e., in case no modifications to the agent are needed):

```bash
# Pull published (production) image
docker pull ghcr.io/cambridge-cares/dh-emission-agent:1.0.0
```

###  **Standalone Deployment**

Deploy the dockerised agent by running the following command from the same location where this README is located (ideally, use a bash terminal to avoid potential issues with inconsistent path separators). 

```bash
# Deploy the Docker image locally
docker compose -f docker-compose.yml up
```

To verify the correct startup of the agent, open the URL address the agent is running on, e.g., `http://localhost:5001/` in your browser. 


### **Stack Deployment**

If you want to spin up this agent as part of a stack, do the following:
1) Build OR pull the (production) image using the commands provided above (do not spin up the image)
2) Copy the `dh-emission-agent.json` file from the [stack-manager-input-config] folder into the `inputs/config/services` folder of the stack manager (and add the service to the target stack config file in `inputs/config/`)
3) Start the stack manager as usual (i.e. `bash ./stack.sh start <STACK_NAME>` from the stack-manager repo). This should start the container. Please use a bash terminal to avoid potential issues with inconsistent path separators.
4) The agent shall become available at `http://<HOST>:<PORT>/DHEmissionAgent/`


## 3.3 Notes on Debugging

To debug the agent within the stack, follow these steps (a similar approach should work for the standalone version)

1) Overwrite command specified in Dockerfile by providing `tail -f /dev/null` `Command` in stack-manager config file (this keeps the container alive indefinitely while doing nothing). An amended `dh-emission-agent-debug` config is provided in the [stack-manager-input-config] folder.
2) Start stack-manager as usual
3) Right click on running agent container -> select "Attach Visual Studio Code"
4) Install required VSCode extensions inside the container
5) Start local debugging session inside container by running `entry_point.py` in debug mode; if HTTP requests from outside do not reach the container, send requests locally from inside the container as workaround


&nbsp;
# 4. Dockerised Agent Tests

Both dockerised unit and integration tests are provided to check for expected behaviour of the emission estimation agents.

```bash
# Build and run dockerised agent tests
docker compose -f "docker-compose-test_dockerised.yml" up -d --build
```

To run the dockerised tests in Debug mode, please run the below command to start up the testing agent and pytest in debug mode. Subsequently, attach the Debugger(s) using the provided `Python: Debug dockerised tests` and `Python: Debug dockerised agent` configurations as required (provided in `.vscode` subfolder). Attaching the `Python: Debug dockerised tests` debugger is required to start the tests, while attaching the debugger to the agent is optional:

```bash
# Build and run dockerised agent tests in debug mode
docker compose -f "docker-compose-test_dockerised_debug.yml" up -d --build
```


&nbsp;
# Authors #
Markus Hofmeister (mh807@cam.ac.uk), August 2023


<!-- Links -->
<!-- websites -->
[allows you to publish and install packages]: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-apache-maven-registry#authenticating-to-github-packages
[CMCL Docker registry wiki page]: https://github.com/cambridge-cares/TheWorldAvatar/wiki/Using-Docker-images
[py4jps]: https://pypi.org/project/py4jps/#description
[Github container registry]: https://ghcr.io
[personal access token]: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens
[Derived Information Framework]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_BASE_LIB/src/main/java/uk/ac/cam/cares/jps/base/derivation
[Stack manager]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/Deploy/stacks/dynamic/stack-manager
[derivation agent]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_BASE_LIB/python_derivation_agent

[OntoTimeSeries]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_Ontology/ontology/ontotimeseries
[OntoHeatNetwork]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_Ontology/ontology/ontoheatnetwork
[OntoDispersion]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_Ontology/ontology/ontodispersion
[OntoDerivation]: https://github.com/cambridge-cares/TheWorldAvatar/tree/main/JPS_Ontology/ontology/ontoderivation

<!-- files -->
[example triples]: ./tests/test_triples/example_abox.ttl
[docker compose file]: ./docker-compose.yml
[stack manager input config file]: ./stack-manager-input-config/emission-agent.json
[stack-manager-input-config]: ./stack-manager-input-config
