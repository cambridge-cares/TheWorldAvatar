package uk.ac.cam.cares.jps.agent.dashboard.json.templating;

import uk.ac.cam.cares.jps.agent.dashboard.utils.StringHelper;

import java.util.List;
import java.util.Map;

/**
 * A Java representation of a JSON-like model that encapsulates and enforces information
 * about PostgreSQL template variable syntax specific to Grafana dashboard. At the moment,
 * the PostgreSQL variables are used to link each asset to their corresponding time series column to perform correct SQL queries.
 *
 * @author qhouyee
 */
class PostgresVariable extends TemplateVariable {
    private final String label;
    private final String description;
    private final String databaseConnectionId;
    private final StringBuilder querySyntax = new StringBuilder();

    /**
     * Constructor for a variable to filter the asset type or rooms associated with a specific facility.
     *
     * @param itemType            The asset type or room for this mapping.
     * @param facilityItemMapping A mapping that maps each item to its facility. Comes in the format of {facility1:[asset1, asset2], facility2:[asset3,asset4]}.
     * @param databaseId          The database connection ID generated by Grafana.
     */
    public PostgresVariable(String itemType, Map<String, List<String>> facilityItemMapping, String databaseId) {
        // Ensure that this variable can be viewed on the dashboard
        super(itemType, 0, true, true);
        // Add label for the type
        if (itemType.equals(StringHelper.ROOM_KEY)) {
            this.label = "Rooms";
        } else if (itemType.equals(StringHelper.SYSTEM_KEY)) {
            this.label = "Smart Meter";
        } else {
            this.label = StringHelper.addSpaceBetweenCapitalWords(itemType);
        }
        // Description should follow the item type
        this.description = "A filter for the items of " + this.label.toLowerCase() + " type.";
        // Append each value in the list in the required format
        this.querySyntax.append("SELECT v AS \\\"__value\\\" FROM (values ");
        StringBuilder temp = new StringBuilder();
        this.databaseConnectionId = databaseId;
        // For each facility, add a query to link the facility and its containing item as a key value pair
        for (Map.Entry<String, List<String>> entry : facilityItemMapping.entrySet()) {
            String facility = entry.getKey();
            entry.getValue().stream().forEach(itemName -> {
                // Only append a comma at the start if it is not the first value
                if (temp.length() != 0) temp.append(", ");
                temp.append("('").append(facility).append("', '")
                        .append(itemName).append("')");
            });
        }
        this.querySyntax.append(temp).append(") AS v(k,v)  WHERE k IN (${").append(StringHelper.FACILITY_KEY).append("});");
    }

    /**
     * Constructor for a variable that filters the measures associated with an asset or room.
     *
     * @param measure       The measure name for this variable.
     * @param item          The asset type or room for this measure.
     * @param databaseId    The database connection ID generated by Grafana.
     * @param assetMeasures A list of time series column and asset names for different assets to be included into the query component.
     */
    public PostgresVariable(String measure, String item, String databaseId, List<String[]> assetMeasures) {
        // Variable name will be a combination of measure name and item type to make it unique
        super(measure + item, 2, true, true);
        // Empty label as the label will not be displayed
        this.label = "";
        // Description should follow the measure name and item type
        this.description = "A hidden filter that displays the corresponding time series of " + StringHelper.addSpaceBetweenCapitalWords(measure).toLowerCase()
                + " for " + StringHelper.addSpaceBetweenCapitalWords(item).toLowerCase();
        // Append each value in the list in the required format
        this.querySyntax.append("SELECT k AS \\\"__text\\\", v AS \\\"__value\\\" FROM (values ");
        StringBuilder temp = new StringBuilder();
        this.databaseConnectionId = databaseId;
        for (String[] assetMeasure : assetMeasures) {
            // Only append a comma at the start if it is not the first value
            if (temp.length() != 0) temp.append(", ");
            // Append the name and the corresponding column name
            temp.append("('").append(assetMeasure[0]).append("', '")
                    .append(assetMeasure[1]).append("')");
        }
        String itemVariable = StringHelper.formatVariableName(item); // Format variable name according to its formatted name
        this.querySyntax.append(temp).append(") AS v(k,v)  WHERE k IN (${").append(itemVariable).append("});");
    }

    /**
     * Construct the Postgres variable as a String.
     *
     * @return The Postgres variable syntax as a String.
     */
    @Override
    protected String construct() {
        // Construct the common elements
        return super.genCommonJson() +
                // Variable display label
                "\"label\": \"" + this.label + "\"," +
                // Postgres datasource
                "\"datasource\": {\"type\": \"postgres\", \"uid\": \"" + this.databaseConnectionId + "\"}," +
                // Description for this variable
                "\"description\": \"" + this.description + "\"," +
                // Query values of this variable
                "\"definition\": \"" + this.querySyntax + "\"," +
                "\"query\": \"" + this.querySyntax + "\"," +
                // Default settings but unsure what they are for
                "\"regex\": \"\"," +
                "\"sort\" : 0," +
                // Variable type must be set as query to work
                "\"type\": \"query\"" +
                "}";
    }
}
